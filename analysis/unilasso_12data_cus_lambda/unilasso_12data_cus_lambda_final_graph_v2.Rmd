# Final version: combine stability with mse, support, sign_diff 9/18 Monday updates 12 datasets
```{r combine stability with mse, support, sign_diff}

### setup####

if (R.home() != "/scratch/users/aqwang/conda/envs/r_package/lib/R") {
  system("/scratch/users/aqwang/conda/envs/r_package/bin/Rscript -e 'rmarkdown::render(\"unilasso_12data_cus_lambda_final_graph.Rmd\")'")
  quit("no")
}

# check the R environment is r_package
R.home()

# set working directory
setwd("/accounts/grad/aqwang/unilasso/analysis/unilasso_12data_cus_lambda")

# load packages 
library(uniLasso) # for unilasso 
library(glmnet) # for cv lasso 
library(dplyr)
library(tidyr)

# Define all dataset names (remove "data_" prefix)
dataset_names <- c(
  "ca_housing", "computer",
  "debutanizer", "diamond", "elevator", "energy_efficiency",
  "insurance", "kin8nm", "miami_housing", "naval_propulsion",
 "protein_structure", "qsar")

####################################################



###################(1)load results for mse, support, sign_diff#################
# read csv file
results_all_splits <- read.csv("/accounts/grad/aqwang/unilasso/analysis/unilasso_12data_cus_lambda/unilasso_12datasets_100splits_train50percent_ownlambda.csv")


# using results_all_splits data frame to graph boxplot of MSE on the left and boxplot of support on the right for each dataset 
library(ggplot2)
library(tidyr)
library(dplyr)

# Reshape data for plotting
plot_long <- results_all_splits %>%
  select(dataset, split_id, unilasso_loo_true_mse, polish_unilasso_mse, lasso_cv_mse, unireg_mse, least_squares_mse,
         unilasso_loo_true_support, polish_unilasso_support, lasso_cv_support,unireg_support, least_squares_support,
         unilasso_loo_true_sign_diff, polish_unilasso_sign_diff,lasso_cv_sign_diff,unireg_sign_diff, least_squares_sign_diff) %>%
  pivot_longer(
    cols = c(unilasso_loo_true_mse, polish_unilasso_mse, lasso_cv_mse, unireg_mse, least_squares_mse,
             unilasso_loo_true_support, polish_unilasso_support, lasso_cv_support, unireg_support, least_squares_support,
             unilasso_loo_true_sign_diff, polish_unilasso_sign_diff, lasso_cv_sign_diff, unireg_sign_diff, least_squares_sign_diff),
    names_to = c("method", ".value"),
    names_pattern = "(unilasso_loo_true|polish_unilasso|lasso_cv|unireg|least_squares)_(mse|support|sign_diff)"
  )

# Order datasets for consistent facetting
desired_order <- c(
  "ca_housing", "debutanizer", "insurance", "kin8nm", 
  "computer", "elevator", "energy_efficiency", "miami_housing", "naval_propulsion",
  "diamond", "protein_structure", "qsar"
)


plot_long$dataset <- factor(plot_long$dataset, levels = desired_order)

# rename unilasso_loo_true to unilasso
plot_long$method <- recode(plot_long$method, unilasso_loo_true = "uniLasso", polish_unilasso = "Polish", lasso_cv = "Lasso", unireg = "uniReg", least_squares = "LS")

# After creating plot_long and recoding the method names, add this line:
plot_long$method <- factor(plot_long$method, levels = c("LS", "Lasso", "uniReg", "uniLasso", "Polish"))

#rename all datasets to have first letter capitalized and underscores replaced with spaces
plot_long$dataset <- recode(plot_long$dataset,
                            "ca_housing" = "CA housing",
                            "debutanizer" = "Debutanizer",
                            "insurance" = "Insurance",
                            "kin8nm" = "Kin8nm",
                            "computer" = "Computer",
                            "elevator" = "Elevator",
                            "energy_efficiency" = "Energy efficiency",
                            "miami_housing" = "Miami housing",
                            "naval_propulsion" = "Naval propulsion",
                            "diamond" = "Diamond",
                            "protein_structure" = "Protein structure",
                            "qsar" = "QSAR"
)

# Create combined long data with metric type including sign_diff
plot_combined_long <- plot_long %>%
  pivot_longer(
    cols = c(mse, support, sign_diff),
    names_to = "metric",
    values_to = "value"
  ) %>%
  mutate(
    metric = recode(metric, 
                   "mse" = "MSE", 
                   "support" = "Support",
                   "sign_diff" = "Number of violations"),
    metric = factor(metric, levels = c("MSE", "Support", "Number of violations"))
  )




# Use similar colors for Polish, uniLasso, and uniReg
method_colors <- c(
  "uniLasso" = "#e41a1c",  # bright red
  "Polish"   = "#e75480",  # medium pink
  "uniReg"   = "#b03060",  # deep rose/magenta
  "Lasso"    = "#2a6eb1",  # balanced medium blue
  "LS"       = "#505050"   # darker gray
)

# only choose the naval propulsion dataset
plot_combined_long3 <- plot_combined_long %>%
  filter(dataset %in% c("Elevator", "Diamond" ,"Naval propulsion"))

# order datasets
plot_combined_long3$dataset <- factor(plot_combined_long3$dataset, levels = c( "Elevator", "Diamond", "Naval propulsion"))


#plot MSE 
plot_combined_long3_mse <- plot_combined_long3 %>% filter(metric == "MSE")  %>%
  group_by(dataset, split_id) %>%
  filter(!any(is.na(value))) %>%
  ungroup()

plot_combined_long3_mse <- plot_combined_long3_mse %>% group_by(dataset, split_id) %>% mutate(avg_mse_per_split = mean(value, na.rm = TRUE)) %>% ungroup() %>% group_by(dataset) %>% mutate(id_ordered = dense_rank(avg_mse_per_split)) %>% ungroup() %>% arrange(dataset, id_ordered)
View(plot_combined_long3_mse )

#colored version for the last 2 datasets 
mse_summary_table_simple3 <- plot_combined_long3_mse %>%
  group_by(dataset, method) %>%
  summarise(mean_mse = mean(value, na.rm = TRUE), .groups = "drop") %>%
  mutate(
    formatted_mse = ifelse(mean_mse > 10000 | mean_mse < 0.1, 
                          formatC(mean_mse, format = "e", digits = 3), 
                          sprintf("%.3f", mean_mse)),
    method_chr = trimws(as.character(method)),
    hex = unname(method_colors[method_chr])
  ) %>%
  group_by(dataset) %>%
  summarise(
    table_text_colored = paste(
      "<b>Mean MSE:</b>",
      paste0(
        "<span style='color:", hex, "'>", 
        method_chr, ": ", formatted_mse, 
        "</span>", 
        collapse = "<br>"
      ),
      sep = "<br>"
    ),
    .groups = "drop"
  )


# Custom labeling function that uses scientific notation for very large/small numbers
scientific_if_needed <- function(x) {
  ifelse(abs(x) >= 10000 | (abs(x) < 0.01 & abs(x) > 0),
         formatC(x, format = "e", digits = 2),
         formatC(x, format = "f", digits = 3))
}


p_mse_ordered_with_avgMSE3 <- ggplot(plot_combined_long3_mse, aes(x = id_ordered, y = value, color = method)) +
  geom_point(alpha = 0.8, size = 4) +
  geom_line(alpha = 0.8, linewidth = 2) +
  # Add table as single text block with colored text
  geom_richtext(data = mse_summary_table_simple3,
                aes(x = -Inf, y = Inf, label = table_text_colored),
                hjust = -0.05, vjust = 4.5,
                size = 14, family = "Times New Roman", fontface = "bold",
                fill = NA,          
                label.color = "gray30",   # Dark gray border
                label.padding = unit(0.35, "lines"),
                label.r = unit(0.2, "lines"),  # Rounded corners
                inherit.aes = FALSE) +
  facet_wrap(~ dataset, scales = "free_y") +
  # Force max value to appear on y-axis
  scale_y_continuous(
    breaks = function(x) {
      # Get pretty breaks
      pretty_breaks <- pretty(x, n = 5)
      # Always include the maximum value
      unique(c(pretty_breaks, max(x)))
    },
    labels = scientific_if_needed  # Custom conditional formatting
    )+
  labs(x = "Split index sorted by mean MSE across methods", y = "MSE", color = "Method") +
  scale_color_manual(values = method_colors) +
  guides(color = guide_legend(override.aes = list(size = 9))) +  # << enlarge color lines
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 40, hjust = 1, size = 50, family = "Times New Roman", face = "bold"),
    axis.text.y = element_text(size = 50, family = "Times New Roman", face = "bold"),  
    axis.title = element_text(size = 80, family = "Times New Roman", face = "bold"),
    legend.position = "bottom",
    legend.box.margin = margin(t = 70, unit = "pt"),
    legend.text = element_text(size = 65, family = "Times New Roman", face = "bold"),
    legend.title = element_text(size = 65, family = "Times New Roman", face = "bold"),
    legend.key.size = unit(8, "lines"),   # << increase dot/line box size
    legend.key.width = unit(8, "lines"),  # << make lines wider
    strip.text = element_text(size = 60, family = "Times New Roman", face = "bold"),
    # Remove grid lines
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )
ggsave("/accounts/grad/aqwang/unilasso/figures_12data/figure_own_lambda/p_mse_line_12data3_custom_lamb.png", 
       plot =p_mse_ordered_with_avgMSE3,  width = 34, height = 35, dpi = 300)
print(p_mse_ordered_with_avgMSE3)



#plot support
plot_combined_long3_support <- plot_combined_long3 %>% filter(metric == "Support", !is.na(value)) 

# Create bar plot 
p_support_bar3 <- ggplot(plot_combined_long3_support, aes(y = as.factor(value), fill = method)) +
  geom_bar(
    orientation = "y",
    color = "gray",       # Border around bars
    linewidth = 0.3,
    alpha = 0.7
  ) +
  facet_grid2(dataset ~ method,
              scales = "free",
              independent = "x") +
  scale_y_discrete(
    labels = function(x) sprintf("%.0f", as.numeric(as.character(x))),  # Format support as integers
    breaks = function(x) x[seq(1, length(x), length.out = length(x))],
    expand = expansion(add = 1)  # Add slight space above and below
  ) +
  labs(x = "Count", y = "Support", fill = "Method") +
  scale_fill_manual(values = method_colors) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 8, family = "Times New Roman", face = "bold"),
    axis.text.y = element_text(size = 8, family = "Times New Roman", face = "bold"),
    axis.title = element_text(size = 12, family = "Times New Roman", face = "bold"),
    legend.position = "bottom",
    legend.text = element_text(size = 12, family = "Times New Roman", face = "bold"),
    legend.title = element_text(size = 12, family = "Times New Roman", face = "bold"),
    strip.text = element_text(size = 10, family = "Times New Roman", face = "bold"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )

ggsave("/accounts/grad/aqwang/unilasso/figures_12data/figure_own_lambda/p_support_bar_12data3_custom_lamb.png", 
       plot =p_support_bar3,  width = 5, height = 5, dpi = 300)

# Display plot
print(p_support_bar3)

```
