# Loop to run uniLasso analysis on all 17 datasets
```{r setup}
if (R.home() != "/scratch/users/aqwang/conda/envs/r_package/lib/R") {
  system("/scratch/users/aqwang/conda/envs/r_package/bin/Rscript -e 'rmarkdown::render(\"unilasso_17data_fixed.Rmd\")'")
  quit("no")
}

# check the R environment is r_package
R.home()

# set working directory
setwd("/accounts/grad/aqwang/unilasso/analysis")

# load packages 
library(uniLasso)
library(glmnet)

# Define all dataset names
dataset_names <- c(
  "data_airfoil", "data_ca_housing", "data_computer", "data_concrete",
  "data_debutanizer", "data_diamond", "data_elevator", "data_energy_efficiency",
  "data_insurance", "data_kin8nm", "data_miami_housing", "data_naval_propulsion",
  "data_parkinsons", "data_powerplant", "data_protein_structure", "data_qsar",
  "data_superconductor"
)

# Initialize results storage
results <- data.frame(
  dataset = character(),
  unilasso_escv_loo_true_mse = numeric(),
  unilasso_cv_loo_true_mse = numeric(),
  unilasso_escv_loo_false_mse = numeric(),
  unilasso_cv_loo_false_mse = numeric(),
  lasso_escv_mse = numeric(),
  lasso_cv_mse = numeric(),
  stringsAsFactors = FALSE
)

```

```{r run_analysis_loop}
# Import required functions
source("ESCV_code2/ESCV_glmnet_vf.R")
source("cv.uniLasso_escv.R")  # Add this line for the correct function
```

```{r run_analysis_loop}
# Loop through all datasets
for (i in seq_along(dataset_names)) {
  dataset_name <- dataset_names[i]
  # visual separator for my output 
  cat("\n", strrep("=", 50), "\n")
  cat("Processing dataset:", dataset_name, "(", i, "/", length(dataset_names), ")\n")
  cat(strrep("=", 50), "\n")
  
  # Load data
  X_path <- paste0("/accounts/grad/aqwang/unilasso/datasets_17/", dataset_name, "/X.csv")
  y_path <- paste0("/accounts/grad/aqwang/unilasso/datasets_17/", dataset_name, "/y.csv")
  
  X <- read.csv(X_path)
  X <- as.matrix(X)
  y <- read.csv(y_path, header = FALSE)
  y <- as.numeric(unlist(y))
  
  cat("Data dimensions: X =", dim(X), ", y =", length(y), "\n")
  
  # Split data into training and test sets
  set.seed(1)
  train_indices <- sample(seq_len(nrow(X)), size = floor(0.8 * nrow(X)))
  Xtr <- X[train_indices, ]
  ytr <- y[train_indices]
  Xte <- X[-train_indices, ]
  yte <- y[-train_indices]
  
  # Center the data for ESCV methods
  Xtr_c <- scale(Xtr, center = TRUE, scale = FALSE)
  ytr_c <- ytr - mean(ytr)
  Xte_c <- scale(Xte, center = attr(Xtr_c, "scaled:center"), scale = FALSE)
  yte_c <- yte - mean(ytr)  # center test y using training mean
  
  # Initialize results for this dataset
  dataset_results <- list()
  
  # 1. UniLasso ESCV (LOO = TRUE)
  cat("Running UniLasso ESCV (LOO = TRUE)...\n")
  set.seed(1)
  tryCatch({
    unilasso_escv_loo_true <- cv.uniLasso_escv(
      Xtr_c, ytr_c,
      family = "gaussian",
      loo = TRUE,
      lower.limits = 0,
      standardize = FALSE
    )
    
    # CV results
    fit <- unilasso_escv_loo_true
    lam_idx <- fit$selindex["CV"]
    lambda <- fit$glmnet.fit$lambda[lam_idx]
    yhat <- predict(fit$glmnet.fit, newx = Xte_c, s = lambda)
    dataset_results$unilasso_cv_loo_true_mse <- mean((yte_c - yhat)^2)
    
    # ESCV results
    lam_idx <- fit$selindex["ESCV"]
    lambda <- fit$glmnet.fit$lambda[lam_idx]
    yhat <- predict(fit$glmnet.fit, newx = Xte_c, s = lambda)
    dataset_results$unilasso_escv_loo_true_mse <- mean((yte_c - yhat)^2)
    
  }, error = function(e) {
    cat("Error in UniLasso ESCV (LOO=TRUE):", e$message, "\n")
    dataset_results$unilasso_escv_loo_true_mse <<- NA
    dataset_results$unilasso_cv_loo_true_mse <<- NA
  })
  
  # 2. UniLasso ESCV (LOO = FALSE)
  cat("Running UniLasso ESCV (LOO = FALSE)...\n")
  set.seed(1)
  tryCatch({
    unilasso_escv_loo_false <- cv.uniLasso_escv(
      Xtr_c, ytr_c,
      family = "gaussian",
      loo = FALSE,
      lower.limits = 0,
      standardize = FALSE
    )
    
    # CV results
    fit <- unilasso_escv_loo_false
    lam_idx <- fit$selindex["CV"]
    lambda <- fit$glmnet.fit$lambda[lam_idx]
    yhat <- predict(fit$glmnet.fit, newx = Xte_c, s = lambda)
    dataset_results$unilasso_cv_loo_false_mse <- mean((yte_c - yhat)^2)
    
    # ESCV results
    lam_idx <- fit$selindex["ESCV"]
    lambda <- fit$glmnet.fit$lambda[lam_idx]
    yhat <- predict(fit$glmnet.fit, newx = Xte_c, s = lambda)
    dataset_results$unilasso_escv_loo_false_mse <- mean((yte_c - yhat)^2)
    
  }, error = function(e) {
    cat("Error in UniLasso ESCV (LOO=FALSE):", e$message, "\n")
    dataset_results$unilasso_escv_loo_false_mse <<- NA
    dataset_results$unilasso_cv_loo_false_mse <<- NA
  })
  
  # 3. Regular Lasso ESCV and CV
  cat("Running Lasso ESCV and CV...\n")
  set.seed(1)
  tryCatch({
    lasso_escv <- escv.glmnet(Xtr_c, ytr_c, k = 10, nlambda = 100)
    
    # ESCV results
    idx_escv <- lasso_escv$selindex["ESCV"]
    beta_path <- as.matrix(lasso_escv$glmnet$beta)
    beta_escv <- beta_path[, idx_escv, drop = FALSE]
    yte_pred_escv <- Xte_c %*% beta_escv + mean(ytr)
    dataset_results$lasso_escv_mse <- mean((yte_pred_escv - yte)^2)
    
    # CV results
    idx_cv <- lasso_escv$selindex["CV"]
    beta_cv <- beta_path[, idx_cv, drop = FALSE]
    yte_pred_cv <- Xte_c %*% beta_cv + mean(ytr)
    dataset_results$lasso_cv_mse <- mean((yte_pred_cv - yte)^2)
    
  }, error = function(e) {
    cat("Error in Lasso ESCV/CV:", e$message, "\n")
    dataset_results$lasso_escv_mse <<- NA
    dataset_results$lasso_cv_mse <<- NA
  })
  
  # Add results to main results dataframe
  new_row <- data.frame(
    dataset = dataset_name,
    unilasso_escv_loo_true_mse = dataset_results$unilasso_escv_loo_true_mse,
    unilasso_cv_loo_true_mse = dataset_results$unilasso_cv_loo_true_mse,
    unilasso_escv_loo_false_mse = dataset_results$unilasso_escv_loo_false_mse,
    unilasso_cv_loo_false_mse = dataset_results$unilasso_cv_loo_false_mse,
    lasso_escv_mse = dataset_results$lasso_escv_mse,
    lasso_cv_mse = dataset_results$lasso_cv_mse,
    stringsAsFactors = FALSE
  )
  
  results <- rbind(results, new_row)
  
  # Print results for this dataset
  cat("Results for", dataset_name, ":\n")
  cat("  UniLasso ESCV (LOO=T):", sprintf("%.6f", dataset_results$unilasso_escv_loo_true_mse), "\n")
  cat("  UniLasso CV (LOO=T):  ", sprintf("%.6f", dataset_results$unilasso_cv_loo_true_mse), "\n")
  cat("  UniLasso ESCV (LOO=F):", sprintf("%.6f", dataset_results$unilasso_escv_loo_false_mse), "\n")
  cat("  UniLasso CV (LOO=F):  ", sprintf("%.6f", dataset_results$unilasso_cv_loo_false_mse), "\n")
  cat("  Lasso ESCV:           ", sprintf("%.6f", dataset_results$lasso_escv_mse), "\n")
  cat("  Lasso CV:             ", sprintf("%.6f", dataset_results$lasso_cv_mse), "\n")
}

cat("\n", strrep("=", 60), "\n")
cat("ANALYSIS COMPLETE!\n")
cat(strrep("=", 60), "\n")
```


```{r run_analysis_loop}
# Loop through all datasets
for (i in seq_along(dataset_names)) {
  dataset_name <- dataset_names[i]
  # visual separator for my output 
  cat("\n", strrep("=", 50), "\n")
  cat("Processing dataset:", dataset_name, "(", i, "/", length(dataset_names), ")\n")
  cat(strrep("=", 50), "\n")
  
  # Load data
  X_path <- paste0("/accounts/grad/aqwang/unilasso/datasets_17/", dataset_name, "/X.csv")
  y_path <- paste0("/accounts/grad/aqwang/unilasso/datasets_17/", dataset_name, "/y.csv")
  
  X <- read.csv(X_path)
  X <- as.matrix(X)
  y <- read.csv(y_path, header = FALSE)
  y <- as.numeric(unlist(y))
  
  cat("Data dimensions: X =", dim(X), ", y =", length(y), "\n")
  
  # Split data into training and test sets
  set.seed(1)
  train_indices <- sample(seq_len(nrow(X)), size = floor(0.8 * nrow(X)))
  Xtr <- X[train_indices, ]
  ytr <- y[train_indices]
  Xte <- X[-train_indices, ]
  yte <- y[-train_indices]
  
  # Center the data for ESCV methods
  Xtr_c <- scale(Xtr, center = TRUE, scale = FALSE)
  ytr_c <- ytr - mean(ytr)
  Xte_c <- scale(Xte, center = attr(Xtr_c, "scaled:center"), scale = FALSE)
  yte_c <- yte - mean(ytr)  # center test y using training mean
  
  # Initialize results for this dataset
  dataset_results <- list()
  
  # 1. UniLasso ESCV (LOO = TRUE)
  cat("Running UniLasso ESCV (LOO = TRUE)...\n")
  set.seed(1)
  tryCatch({
    unilasso_escv_loo_true <- cv.uniLasso_escv(
      Xtr_c, ytr_c,
      family = "gaussian",
      loo = TRUE,
      lower.limits = 0,
      standardize = FALSE
    )
    
    # CV results
    fit <- unilasso_escv_loo_true
    lam_idx <- fit$selindex["CV"]
    lambda <- fit$glmnet.fit$lambda[lam_idx]
    yhat <- predict(fit$glmnet.fit, newx = Xte_c, s = lambda)
    dataset_results$unilasso_cv_loo_true_mse <- mean((yte_c - yhat)^2)
    
    # ESCV results
    lam_idx <- fit$selindex["ESCV"]
    lambda <- fit$glmnet.fit$lambda[lam_idx]
    yhat <- predict(fit$glmnet.fit, newx = Xte_c, s = lambda)
    dataset_results$unilasso_escv_loo_true_mse <- mean((yte_c - yhat)^2)
    
  }, error = function(e) {
    cat("Error in UniLasso ESCV (LOO=TRUE):", e$message, "\n")
    dataset_results$unilasso_escv_loo_true_mse <<- NA
    dataset_results$unilasso_cv_loo_true_mse <<- NA
  })
  
  # 2. UniLasso ESCV (LOO = FALSE)
  cat("Running UniLasso ESCV (LOO = FALSE)...\n")
  set.seed(1)
  tryCatch({
    unilasso_escv_loo_false <- cv.uniLasso_escv(
      Xtr_c, ytr_c,
      family = "gaussian",
      loo = FALSE,
      lower.limits = 0,
      standardize = FALSE
    )
    
    # CV results
    fit <- unilasso_escv_loo_false
    lam_idx <- fit$selindex["CV"]
    lambda <- fit$glmnet.fit$lambda[lam_idx]
    yhat <- predict(fit$glmnet.fit, newx = Xte_c, s = lambda)
    dataset_results$unilasso_cv_loo_false_mse <- mean((yte_c - yhat)^2)
    
    # ESCV results
    lam_idx <- fit$selindex["ESCV"]
    lambda <- fit$glmnet.fit$lambda[lam_idx]
    yhat <- predict(fit$glmnet.fit, newx = Xte_c, s = lambda)
    dataset_results$unilasso_escv_loo_false_mse <- mean((yte_c - yhat)^2)
    
  }, error = function(e) {
    cat("Error in UniLasso ESCV (LOO=FALSE):", e$message, "\n")
    dataset_results$unilasso_escv_loo_false_mse <<- NA
    dataset_results$unilasso_cv_loo_false_mse <<- NA
  })
  
  # 3. Regular Lasso ESCV and CV
  cat("Running Lasso ESCV and CV...\n")
  set.seed(1)
  tryCatch({
    lasso_escv <- escv.glmnet(Xtr_c, ytr_c, k = 10, nlambda = 100)
    
    # ESCV results
    idx_escv <- lasso_escv$selindex["ESCV"]
    beta_path <- as.matrix(lasso_escv$glmnet$beta)
    beta_escv <- beta_path[, idx_escv, drop = FALSE]
    yte_pred_escv <- Xte_c %*% beta_escv + mean(ytr)
    dataset_results$lasso_escv_mse <- mean((yte_pred_escv - yte)^2)
    
    # CV results
    idx_cv <- lasso_escv$selindex["CV"]
    beta_cv <- beta_path[, idx_cv, drop = FALSE]
    yte_pred_cv <- Xte_c %*% beta_cv + mean(ytr)
    dataset_results$lasso_cv_mse <- mean((yte_pred_cv - yte)^2)
    
  }, error = function(e) {
    cat("Error in Lasso ESCV/CV:", e$message, "\n")
    dataset_results$lasso_escv_mse <<- NA
    dataset_results$lasso_cv_mse <<- NA
  })
  
  # Add results to main results dataframe
  new_row <- data.frame(
    dataset = dataset_name,
    unilasso_escv_loo_true_mse = dataset_results$unilasso_escv_loo_true_mse,
    unilasso_cv_loo_true_mse = dataset_results$unilasso_cv_loo_true_mse,
    unilasso_escv_loo_false_mse = dataset_results$unilasso_escv_loo_false_mse,
    unilasso_cv_loo_false_mse = dataset_results$unilasso_cv_loo_false_mse,
    lasso_escv_mse = dataset_results$lasso_escv_mse,
    lasso_cv_mse = dataset_results$lasso_cv_mse,
    stringsAsFactors = FALSE
  )
  
  results <- rbind(results, new_row)
  
  # Print results for this dataset
  cat("Results for", dataset_name, ":\n")
  cat("  UniLasso ESCV (LOO=T):", sprintf("%.6f", dataset_results$unilasso_escv_loo_true_mse), "\n")
  cat("  UniLasso CV (LOO=T):  ", sprintf("%.6f", dataset_results$unilasso_cv_loo_true_mse), "\n")
  cat("  UniLasso ESCV (LOO=F):", sprintf("%.6f", dataset_results$unilasso_escv_loo_false_mse), "\n")
  cat("  UniLasso CV (LOO=F):  ", sprintf("%.6f", dataset_results$unilasso_cv_loo_false_mse), "\n")
  cat("  Lasso ESCV:           ", sprintf("%.6f", dataset_results$lasso_escv_mse), "\n")
  cat("  Lasso CV:             ", sprintf("%.6f", dataset_results$lasso_cv_mse), "\n")
}

cat("\n", strrep("=", 60), "\n")
cat("ANALYSIS COMPLETE!\n")
cat(strrep("=", 60), "\n")
```


```{r create_comparison_plot}
# Create meaningful comparison plots
library(ggplot2)
library(tidyr)
library(dplyr)
library(ggrepel)
library(ggsci)
library(stringr)  # for str_trim

# 1. RELATIVE PERFORMANCE COMPARISON (most meaningful)
# For each dataset, find the best method and calculate relative MSE
results_relative <- results %>%
  mutate(
    best_mse = pmin(unilasso_escv_loo_true_mse, unilasso_cv_loo_true_mse, 
                    unilasso_escv_loo_false_mse, unilasso_cv_loo_false_mse,
                    lasso_escv_mse, lasso_cv_mse, na.rm = TRUE)
  ) %>%
  mutate(
    unilasso_escv_loo_true_rel = unilasso_escv_loo_true_mse / best_mse,
    unilasso_cv_loo_true_rel = unilasso_cv_loo_true_mse / best_mse,
    unilasso_escv_loo_false_rel = unilasso_escv_loo_false_mse / best_mse,
    unilasso_cv_loo_false_rel = unilasso_cv_loo_false_mse / best_mse,
    lasso_escv_rel = lasso_escv_mse / best_mse,
    lasso_cv_rel = lasso_cv_mse / best_mse
  )

# Reshape for plotting relative performance
results_rel_long <- results_relative %>%
  select(dataset, ends_with("_rel")) %>%
  pivot_longer(cols = ends_with("_rel"), 
               names_to = "method", 
               values_to = "relative_mse") %>%
  mutate(dataset = factor(str_trim(as.character(dataset))))%>%
  mutate(
    method = case_when(
      method == "unilasso_escv_loo_true_rel" ~ "UniLasso ESCV (LOO=T)",
      method == "unilasso_cv_loo_true_rel" ~ "UniLasso CV (LOO=T)",
      method == "unilasso_escv_loo_false_rel" ~ "UniLasso ESCV (LOO=F)",
      method == "unilasso_cv_loo_false_rel" ~ "UniLasso CV (LOO=F)",
      method == "lasso_escv_rel" ~ "Lasso ESCV",
      method == "lasso_cv_rel" ~ "Lasso CV",
      TRUE ~ method
    )
  )

# Plot 1: Relative performance (most meaningful)
# get outliers for each method separately (e.g., Q1-1.5*IQR, Q3+1.5*IQR)
method_thresholds <- results_rel_long %>%
  group_by(method) %>%
  summarise(
    lower = quantile(relative_mse, 0.25, na.rm = TRUE) - 1.5 * IQR(relative_mse, na.rm = TRUE),
    upper = quantile(relative_mse, 0.75, na.rm = TRUE) + 1.5 * IQR(relative_mse, na.rm = TRUE)
  )
print(method_thresholds)

# Find the dataset with the largest relative MSE for each method,
# but skip labeling for "Lasso CV" since all are 1
# label all methods' outliers MSEC(based on method_thresholds)
outlier_points <- results_rel_long %>%
  inner_join(method_thresholds, by = "method") %>%
  filter(relative_mse > upper) %>%
  select(method, dataset, relative_mse) %>%
  arrange(method, desc(relative_mse))


ds_levels <- levels(results_rel_long$dataset)

# Assign a distinct color for each dataset using scale_color_manual
dataset_colors <- setNames(
  pal_d3("category20")(length(ds_levels)),
  ds_levels
)
p1_all <- ggplot(results_rel_long, aes(x = method, y = log10(relative_mse), fill = method)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(width = 0.2, alpha = 0.8, aes(color = dataset)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red", alpha = 0.7) +
  scale_color_manual(values = dataset_colors, na.value = "black", drop = FALSE) +

  ## <- replace geom_text() with geom_text_repel()
  geom_text_repel(
    data = outlier_points,
    aes(x = method, y = log10(relative_mse), label = dataset, color = dataset),
    direction = "y",           # mostly separate vertically
    box.padding = 0.25,        # room around labels
    point.padding = 0.15,      # room around the anchor point
    force = 1,                 # repel strength
    force_pull = 0.5,          # pull toward data point
    min.segment.length = 0,    # always draw a leader line
    segment.size = 0.2,
    segment.alpha = 0.6,
    seed = 123,                # reproducible layout
    max.overlaps = Inf,        # don't drop labels
    show.legend = FALSE
  ) +

  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 14),
    axis.text.y = element_text(size = 14),
    axis.title.x = element_text(size = 18),
    axis.title.y = element_text(size = 18),
    plot.title = element_text(size = 20, face = "bold"),
    plot.subtitle = element_text(size = 16),
    legend.position = "bottom",
    legend.title = element_blank(),
    plot.margin = margin(8, 16, 8, 8)  # extra room for repelled labels
  ) +
  labs(
    title = "Relative MSE Performance Across 17 Datasets (All Data)",
    subtitle = "Each dataset normalized by its best method (red line = best performance)",
    x = "Method",
    y = expression(log[10]*"(Relative MSE)")
  ) +
  guides(fill = "none") +
  coord_cartesian(
    clip = "off",
    ylim = c(min(log10(results_rel_long$relative_mse), na.rm = TRUE),
             max(log10(results_rel_long$relative_mse), na.rm = TRUE) + 0.5)
  )

p1_all + theme(aspect.ratio = 0.5)
print(p1_all)

# 3. WIN/LOSS ANALYSIS (most interpretable)
win_analysis <- results_rel_long %>%
  group_by(method) %>%
  summarise(
    # Counts how many times this method had a relative_mse of exactly 1 (within a tiny tolerance), meaning it was the best for that dataset.
    times_best = sum(abs(relative_mse - 1) < 1e-10, na.rm = TRUE),
    mean_relative_performance = mean(relative_mse, na.rm = TRUE),
    median_relative_performance = median(relative_mse, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  arrange(desc(times_best), mean_relative_performance)

p3 <- ggplot(win_analysis, aes(x = reorder(method, times_best), y = times_best)) +
  geom_col(fill = "steelblue", alpha = 0.7) +
  geom_text(aes(label = times_best), hjust = -0.1) +
  coord_flip() +
  theme_minimal() +
  labs(title = "How Often Each Method Wins (Best Performance)",
       x = "Method", y = "Number of Datasets Where Method Was Best")

print(p3)

# draw a plot regarding the mean/median relative performance
p4 <- ggplot(win_analysis, aes(x = reorder(method, mean_relative_performance), y = mean_relative_performance)) +
  geom_col(fill = "coral", alpha = 0.7) +
  geom_text(
    aes(
      label = round(mean_relative_performance, 2),
      hjust = ifelse(method == "UniLasso ESCV (LOO=T)", 1, -0.1)
    )
  ) +
  coord_flip() +
  theme_minimal() +
  labs(
    title = "Mean Relative Performance of Each Method",
    x = "Method", y = "Mean Relative MSE (lower is better)"
  )
p4 + theme(aspect.ratio = 2)
print(p4)


# Print win analysis table
cat("\n", strrep("=", 80), "\n")
cat("METHODS RANKED BY PERFORMANCE\n")
cat(strrep("=", 80), "\n")
print(win_analysis)
```

```{r check the 22 datasets}



```